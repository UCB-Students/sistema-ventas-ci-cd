name: Deploy Staging
on:
  workflow_call:

jobs:
  staging:
    runs-on: self-hosted
    environment: staging
    steps:
      - name: Descargar Artefacto
        uses: actions/download-artifact@v4
        with:
          name: app-package
      
      - name: Despliegue Atómico Staging
        run: |
          # 1. Definir rutas
          RELEASE_PATH=/var/www/sistemaventas-staging/releases/${{ github.sha }}
          mkdir -p $RELEASE_PATH
          
          # 2. Descomprimir
          tar -xzf release.tar.gz -C $RELEASE_PATH
          
          # 3. Vincular configuración compartida
          ln -sfn /var/www/sistemaventas-staging/shared/.env $RELEASE_PATH/.env
          
          # 4. Ajustar Permisos (ESTE ES EL PUNTO CLAVE)
          # Cambiamos el grupo a www-data y damos permisos de escritura a storage y cache
          chown -R fellsing:www-data $RELEASE_PATH
          chmod -R 775 $RELEASE_PATH/storage
          chmod -R 775 $RELEASE_PATH/bootstrap/cache
          
          # 5. Optimización de Laravel
          cd $RELEASE_PATH
          php artisan optimize:clear
          php artisan migrate --force
          
          # 6. Actualizar enlace simbólico (Poner en vivo)
          ln -sfn $RELEASE_PATH /var/www/sistemaventas-staging/current
          
      - name: Health Check
        run: |
          # Damos 5 segundos para que PHP-FPM reconozca el nuevo release
          sleep 5
          curl -f http://192.168.1.35:9090/api/health

      - name: Rollback en caso de fallo
        if: failure()
        run: |
          echo "¡El despliegue falló! Iniciando Rollback..."
          # Buscamos el release anterior (el penúltimo en la lista ordenada por fecha)
          PREV_RELEASE=$(ls -1dt /var/www/sistemaventas-staging/releases/*/ | sed -n '2p' | sed 's/\/$//')
          
          if [ -n "$PREV_RELEASE" ]; then
            echo "Restaurando release anterior: $PREV_RELEASE"
            ln -sfn $PREV_RELEASE /var/www/sistemaventas-staging/current
            echo "Rollback completado exitosamente."
          else
            echo "No se encontró un release anterior para restaurar."
          fi