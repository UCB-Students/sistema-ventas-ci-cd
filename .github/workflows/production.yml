name: Deploy Production
on:
  workflow_call:

jobs:
  production:
    runs-on: self-hosted
    environment: production
    steps:
      - name: Descargar Artefacto
        uses: actions/download-artifact@v4
        with:
          name: app-package

      - name: Despliegue Atómico Producción
        run: |
          # 1. Definir rutas
          RELEASE_PATH=/var/www/sistemaventas-prod/releases/${{ github.sha }}
          mkdir -p $RELEASE_PATH
          tar -xzf release.tar.gz -C $RELEASE_PATH
          
         
          # 2. Copiar configuración base
          cp /var/www/sistemaventas-prod/shared/.env $RELEASE_PATH/.env
          
          # 3. Sobrescribir variables específicas con Secretos (PROD)
          # 3. Sobrescribir variables específicas con Secretos (Seguro para caracteres especiales)
          function set_env() {
              key=$1
              val=$2
              # Borrar la línea si existe
              if grep -q "^$key=" $RELEASE_PATH/.env; then
                  sed -i "/^$key=/d" $RELEASE_PATH/.env
              fi
              # Agregar al final
              echo "$key=$val" >> $RELEASE_PATH/.env
          }

          set_env "APP_ENV" "production"
          set_env "APP_DEBUG" "false"
          set_env "APP_URL" "${{ secrets.APP_URL }}"
          
          set_env "DB_CONNECTION" "${{ secrets.DB_CONNECTION }}"
          set_env "DB_DATABASE" "${{ secrets.DB_DATABASE }}"
          set_env "DB_USERNAME" "${{ secrets.DB_USERNAME }}"
          set_env "DB_PASSWORD" "${{ secrets.DB_PASSWORD }}"
          

          # 4. Permisos de escritura (Solo chmod, que es seguro para el pipeline)
          chmod -R 775 $RELEASE_PATH/storage
          chmod -R 775 $RELEASE_PATH/bootstrap/cache
          
          # 5. Laravel y Observabilidad (Punto D)
          cd $RELEASE_PATH
          php artisan optimize:clear
          php artisan migrate --force
          logger -t "CI-CD-PROD" "DEPLOY_SUCCESS RELEASE=${{ github.sha }} USER=${{ github.actor }}"
          
          # 6. Activación del release
          ln -sfn $RELEASE_PATH /var/www/sistemaventas-prod/current

      - name: Health Check Final
        run: |
          echo "Esperando a que los servicios se estabilicen..."
          sleep 10
          # Usamos -f para que falle el pipeline si no da 200, pero -s para no llenar el log de basura
          curl -f -s ${{ secrets.APP_URL }}/api/health || (echo "El Health Check falló. Revisa logs de PHP-FPM" && exit 1)

      - name: Rollback en caso de fallo
        if: failure()
        run: |
          echo "¡El despliegue falló! Iniciando Rollback..."
          # Buscamos el release anterior (el penúltimo en la lista ordenada por fecha)
          PREV_RELEASE=$(ls -1dt /var/www/sistemaventas-prod/releases/*/ | sed -n '2p' | sed 's/\/$//')
          
          if [ -n "$PREV_RELEASE" ]; then
            echo "Restaurando release anterior: $PREV_RELEASE"
            ln -sfn $PREV_RELEASE /var/www/sistemaventas-prod/current
            echo "Rollback completado exitosamente."
          else
            echo "No se encontró un release anterior para restaurar."
          fi